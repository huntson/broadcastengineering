<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Device-Name Editor</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    body {
      background: #18191A !important;
      color: #F0F2F5 !important;
    }
    .table {
      background: #23272b;
      color: #fff;
    }
    .table th, .table td {
      background: #23272b !important;
      color: #f8f8f8 !important;
      border-color: #343a40 !important;
    }
    .form-control,
    .input-group-text {
      background: #23272b !important;
      color: #f8f8f8 !important;
      border-color: #444 !important;
    }
    .form-control:focus {
      background: #2c2f33 !important;
      color: #fff !important;
      border-color: #007bff !important;
      box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
    }
    .btn-primary,
    .btn-success,
    .btn-outline-secondary {
      background: #343a40;
      color: #f8f8f8;
      border-color: #555;
    }
    .btn-primary:hover,
    .btn-success:hover,
    .btn-outline-secondary:hover {
      background: #007bff !important;
      color: #fff !important;
      border-color: #007bff !important;
    }
    hr {
      border-color: #444;
    }
  </style>
</head>
<body class="p-4">

  <h3>Step 1 – download config</h3>
  <form id="dlForm" class="row gy-2 gx-2 align-items-end">
    <div class="col-auto">
      <textarea class="form-control"
                id="device_ips"
                name="device_ips"
                placeholder="127.0.0.1"
                rows="2">127.0.0.1</textarea>
    </div>
    <div class="col-auto">
      <button type="submit" class="btn btn-primary">Download</button>
    </div>
  </form>

  <!-- Override warning: shown when configs differ -->
  <div id="conflict-warning" style="display:none; margin-top:1em;">
    <div class="alert alert-danger">
      ⚠️ The selected units have different configurations. By default, you can't edit them together.
    </div>
    <div class="form-check">
      <input class="form-check-input" type="checkbox" id="force-override">
      <label class="form-check-label" for="force-override">
        Ignore differences and apply my edits to all selected units
      </label>
    </div>
    <button type="button" id="retry-download" class="btn btn-primary mt-2">
      Continue with override
    </button>
  </div>

  <hr/>

  <div id="editor" style="display:none">
    <h3>Step 2 – edit or sync</h3>
    <table class="table" id="nameTable"></table>

    <div class="input-group my-3">
      <span class="input-group-text">Google Sheet URL</span>
      <input class="form-control" id="sheetURL" type="url"/>
      <button class="btn btn-outline-secondary" id="syncBtn">Sync</button>
    </div>
    <button type="button" id="normalize-btn" class="btn btn-secondary mb-3">
      Default Names
    </button>

    <h3>Step 3 – upload</h3>
    <form id="uploadForm" class="row gy-2 gx-2 align-items-end">
      <div class="col-auto"></div>
      <div class="col-auto">
        <button class="btn btn-success">Upload</button>
      </div>
    </form>

    <div id="uploadProgress" style="display: none; margin-top: 1em;">
      <progress></progress>
      <span>Uploading…</span>
    </div>
    <pre id="uploadLog"
         class="mt-3 text-light bg-dark p-3 rounded"
         style="white-space:pre-wrap"></pre>
  </div>

  <script>
    // Grab elements
    const dlForm                = document.getElementById('dlForm');
    const conflictWarning       = document.getElementById('conflict-warning');
    const retryBtn              = document.getElementById('retry-download');
    const forceOverrideCheckbox = document.getElementById('force-override');
    const deviceIpsTextarea     = document.getElementById('device_ips');

    let token = null, names = [];

    // Load saved IPs from server on page load
    window.addEventListener('DOMContentLoaded', async () => {
      try {
        const response = await fetch('/get_saved_ips');
        const data = await response.json();
        if (data.ips) {
          deviceIpsTextarea.value = data.ips;
          // Also save to localStorage as backup
          localStorage.setItem('cobalt_device_ips', data.ips);
        } else {
          // Fallback to localStorage if server has no saved IPs
          const savedIps = localStorage.getItem('cobalt_device_ips');
          if (savedIps) {
            deviceIpsTextarea.value = savedIps;
          }
        }
      } catch (error) {
        console.error('Failed to load saved IPs from server:', error);
        // Fallback to localStorage on error
        const savedIps = localStorage.getItem('cobalt_device_ips');
        if (savedIps) {
          deviceIpsTextarea.value = savedIps;
        }
      }
    });

    // Save IPs to both server and localStorage when changed
    let saveTimeout;
    deviceIpsTextarea.addEventListener('input', () => {
      const ipsValue = deviceIpsTextarea.value;
      // Save to localStorage immediately
      localStorage.setItem('cobalt_device_ips', ipsValue);

      // Debounce server save to avoid too many requests
      clearTimeout(saveTimeout);
      saveTimeout = setTimeout(async () => {
        try {
          await fetch('/save_ips', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ips: ipsValue })
          });
        } catch (error) {
          console.error('Failed to save IPs to server:', error);
        }
      }, 1000); // Wait 1 second after user stops typing
    });

    // Unified download logic with override support
    async function startDownload(override) {
      conflictWarning.style.display = 'none';

      // Parse IP list
      const ipsRaw = deviceIpsTextarea.value;
      const ips = ipsRaw.split(',')
                         .map(ip => ip.trim())
                         .filter(ip => ip);

      // Save to both localStorage and server
      localStorage.setItem('cobalt_device_ips', ipsRaw);
      try {
        await fetch('/save_ips', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ips: ipsRaw })
        });
      } catch (error) {
        console.error('Failed to save IPs to server:', error);
      }

      // Fetch via JSON
      const res = await fetch('/download', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ips, overrideDifferences: override })
      });

      if (res.status === 409) {
        conflictWarning.style.display = '';
        return;
      }

      const js = await res.json();
      token = js.token;
      names = js.names;
      document.getElementById('editor').style.display = '';
      renderTable();
    }

    // Hook up buttons
    dlForm.onsubmit = e => { e.preventDefault(); startDownload(false); };
    retryBtn.onclick = () => startDownload(forceOverrideCheckbox.checked);

    // Default-names button
    document.getElementById('normalize-btn').addEventListener('click', () => {
      const inputs = Array.from(document.querySelectorAll('#nameTable input'));
      const defaultNames = inputs.map((_, i) =>
        `CCFS ${String(i + 1).padStart(2, '0')}`
      );
      defaultNames.forEach((name, idx) => inputs[idx].value = name);
      names = defaultNames.slice();
      renderTable();
    });

    // Render the editable table
    function renderTable() {
      const tbl = document.getElementById('nameTable');
      tbl.innerHTML = names.map((n, i) => `
        <tr data-row="${i}">
          <td>${i+1}</td>
          <td>
            <input class="form-control"
                   value="${n||''}"
                   onchange="names[${i}] = this.value">
          </td>
        </tr>`).join('');
    }

    // Sync with Google Sheet
    document.getElementById('syncBtn').onclick = async () => {
      const sheetURL = document.getElementById('sheetURL').value;
      if (!sheetURL) return;
      const fd = new FormData();
      fd.append('token', token);
      fd.append('sheet_url', sheetURL);
      const r = await fetch('/sync', { method: 'POST', body: fd });
      if (!r.ok) {
        alert('Sheet error: ' + await r.text());
        return;
      }
      const js = await r.json();
      names.splice(0, names.length, ...js.names);
      renderTable();
    };

    // Upload edited names
    document.getElementById('uploadForm').onsubmit = async e => {
      e.preventDefault();
      const prog = document.getElementById('uploadProgress');
      const log  = document.getElementById('uploadLog');
      prog.style.display = '';

      const newNames = Array.from(
        document.querySelectorAll('#nameTable input')
      ).map(i => i.value.trim());

      const fd = new FormData();
      fd.append('token', token);
      fd.append('names', JSON.stringify(newNames));

      const res = await fetch('/save', { method: 'POST', body: fd });
      const txt = await res.text();
      prog.style.display = 'none';

      let results;
      try {
        results = JSON.parse(txt).results;
      } catch {
        alert('Server replied:\n\n' + txt);
        return;
      }

      log.textContent = Object.entries(results)
        .map(([ip,out]) => `${ip}\n${out}`)
        .join("\n\n──────────────\n\n");
    };
  </script>

</body>
</html>
